<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <meta name="description" content="Emoticommits : Commits and comments with emotions are good for your health :smile:" />
  <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css">
  <link rel="stylesheet" type="text/css" href="stylesheets/emoji.css">
  <script type="text/javascript" src="javascripts/markerqueue.js"></script>
  <script type="text/javascript" src="javascripts/sun.js"></script>
  <script type="text/javascript">
    var page_time;
    var mapwindow;

    var marker_conf = {
      avatar: {
        duration: 600*1000, // 10 min
        size: 32
      },
      emoticon: {
        duration: 1800*1000, // 30 min
        size: 48
      }
    };

    var markers_queue = new Array;
    var loaded_basename;

    var markers = {
      queue: new Array,
      avatars: new Array,
      emoticons: new Array,
    };

    var updater;
    function startUpdate() {
      updater = setInterval(function(){
        updateClocks();
        basename = 
          MarkerQueue.basename(new Date(page_time.getTime() + fetch_offset));
        if (basename != loaded_basename) {
          MarkerQueue.load(basename, markers, page_time);
          loaded_basename = basename;
        }
      }, 1000);
    };

    var time_offset;  // offset of time of markers from RTC in msec
    var fetch_offset = 15*60*1000*(0.5+Math.random());  // 7.5-22.5 minutes
    function updateClocks() {
      var wall_time = new Date();
      page_time = new Date(wall_time.getTime() + time_offset);
      document.getElementById("page_clock").innerHTML = page_time.toLocaleString();
      MarkerQueue.add(page_time, wall_time, markers, marker_conf, mapwindow);
      MarkerQueue.remove(wall_time, markers, mapwindow);
    };

    function changeOffset() {
      clearInterval(updater);
      MarkerQueue.clear(markers);
      s = document.getElementById('select_offset');
      time_offset = -24*3600*1000 * s.options[s.selectedIndex].value;
      updateClocks();
      mapwindow.setShadowArrays(Sun.shadowPaths(page_time));
      loaded_basename =
        MarkerQueue.basename(new Date(page_time.getTime()));
      MarkerQueue.load(loaded_basename, markers, page_time);
      startUpdate();
    }

    function zoomToInitial() {
      mapwindow.zoomToInitial();
      document.getElementById("zoom_back").disabled = true;
    }

    function initialize() {
      mapwindow = document.getElementById("mapframe").contentWindow;
      changeOffset();
      mapwindow.onViewChanged(function(){
        document.getElementById("zoom_back").disabled = false;
      });
      setInterval(function(){
        mapwindow.setShadowArrays(Sun.shadowPaths(page_time));
      }, 60000);
    }

    window.onload = initialize;
  </script>

  <title>Emoticommits</title>
</head>

<body>
<div id="header">
  <div id="title"><h1>Emoticommits</h1></div>
  <div id="description">
    <p>Commits and comments with emotions are good for your health
    <img class="emoji" title=":smile:" alt=":smile:" src="http://assets.github.com/images/icons/emoji/smile.png">.
    The map shows <em>some of</em> activites of <a href="https://github.com">GitHub
    <img class="emoji" title=":octocat:" alt=":octocat:" src="http://assets.github.com/images/icons/emoji/octocat.png"></a>
    users.
    Please see <a href="https://github.com/zunda/emoticommits#readme">README</a> for details.</p>
  </div>
</div>

<div id="control">
  <div id="control_left">
    <form><select id="select_offset" onChange="changeOffset()">
      <option value="0.5">12 hours</option>
      <option value="1">24 hours</option>
      <option selected value="7">7 days</option>
      </select> ago at <span id="page_clock">page clock</span>
    </form>
  </div>
  <div id="control_right">
    <form>
      <input id="zoom_back" type="button" value="Zoom back"
        onClick="zoomToInitial()" disabled>
    </form>
  </div>
</div>

<div id="main">
  <iframe id="mapframe" src="./map.html" class="mapframe"
    frameBorder="0" scrolling="no"></iframe>
</div>
</body>
</html>
